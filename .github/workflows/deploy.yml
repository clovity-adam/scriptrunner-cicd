name: Deploy ScriptRunner Scripts (Test via Tailscale)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Join your tailnet so SSH/rsync/scp can reach rhel-jira-02
      - name: Tailscale up
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: stable

      - name: Deploy ScriptRunner artifact
        env:
          SSH_HOST: rhel-jira-02                 # host reachable via Tailscale
          SSH_USER: root                         # or a non-root account with write access to shared home
          SHARED_HOME: /mnt/jira_shared
          RELEASE_VER: ${{ github.run_number }}-${{ github.sha }}
          # Route SSH over Tailscale; accept host key on first connect
          SSH_OPTS: -o ProxyCommand="tailscale nc %h %p" -o StrictHostKeyChecking=accept-new
        run: bash ops/deploy.sh
