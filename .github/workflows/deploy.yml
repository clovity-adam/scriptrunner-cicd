name: Deploy ScriptRunner (DEV via Tailscale)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Bring this runner onto your tailnet
      - name: Tailscale up
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          # If you use MagicDNS, add your tailnet's domain; otherwise use the node's Tailscale IP
          version: stable

      # Optional pack; we deploy the raw scripts directory regardless
      - name: Package (optional)
        run: bash ops/pack.sh || true

      - name: Deploy to Shared Home via Tailscale
        env:
          # Your Jira node or any host that can write to /mnt/jira_shared
          SSH_HOST: rhel-jira-02   # or the node's Tailscale IP
          SSH_USER: root
          SHARED_HOME: /mnt/jira_shared
          RELEASE_VER: ${{ github.run_number }}-${{ github.sha }}
          # Route ssh/rsync over Tailscale
          SSH_OPTS: -o ProxyCommand="tailscale nc %h %p" -o StrictHostKeyChecking=accept-new
        run: bash ops/deploy.sh
